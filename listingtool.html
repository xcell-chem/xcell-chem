<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="editor">
        <div class="container">
            <div class="left-column">
                <label for="name">Product Name</label>
                <input type="text" id="name" />

                <label for="img">Image URL</label>
                <input type="text" id="img" />
                <button id="changeImageButton">Change Image</button>
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="previewImage(event)" />
                <img id="imagePreview" src="" alt="Product Image" style="display:none;" />

                <label for="active">Active</label>
                <input type="checkbox" id="active" />
                <label for="archived">Archived</label>
                <input type="checkbox" id="archived" disabled />

                <div>
                    <button id="saveRecordButton" type="button">Save Record</button>
                    <button id="saveNewRecordButton" type="button">Save New Record</button>
                </div>
                <div>
                    <button id="previousRecordButton" type="button">Previous</button>
                    <button id="nextRecordButton" type="button">Next</button>
                </div>
            </div>

            <div class="middle-column">
                <label for="shortdescription">Short Description</label>
                <textarea id="shortdescription" rows="4"></textarea>

                <label for="description">Description</label>
                <textarea id="description" rows="4"></textarea>
            </div>

            <div class="right-column">
                <h3>Selected Categories</h3>
                <ul class="category-list" id="categoryList"></ul>

                <h3>All Categories</h3>
                <select id="availableCategories"></select>
                <button id="addCategoryButton" type="button">Add Category</button>

                <h3>Prices</h3>
                <div id="priceTableContainer"></div>
                <button id="addPricingRowButton" type="button">Add Price</button>
            </div>
        </div>
    </div>

    <!-- Load Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://tjbcucdewwczndkeypey.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqYmN1Y2Rld3djem5ka2V5cGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzUwMzcsImV4cCI6MjA1MzUxMTAzN30.iBm2u7xY5qRQT6gOQw7OwAYTENJh49B9lI0YtLuKJAQ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let currentIndex = 0;
        let products = [];

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[Debug] DOMContentLoaded event fired.');
            restoreFromLocalStorage();
            await loadProducts();
            await loadCategories();
            attachEventListeners();
        });

        async function loadProducts() {
            try {
                console.log('[loadProducts] Fetching products...');
                const { data, error } = await supabaseClient
                    .from('products')
                    .select(`
                        *,
                        product_prices (quantity, price),
                        product_category (categories (name)) -- Fetch category name
                    `);

                if (error) throw error;

                products = data;
                if (products.length > 0) {
                    populateProductDetails(products[currentIndex]);
                } else {
                    alert('No products found in the database.');
                }
            } catch (error) {
                console.error('[Error] Failed to load products:', error);
                alert('Failed to load products. Check the console for details.');
            }
        }

        async function loadCategories() {
            try {
                console.log('[loadCategories] Fetching categories...');
                const { data: categories, error } = await supabaseClient.from('categories').select('*');
                if (error) throw error;

                const categoryDropdown = document.getElementById('availableCategories');
                categoryDropdown.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id; // Assuming category has an 'id' field
                    option.textContent = category.name;
                    categoryDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('[Error] Failed to load categories:', error);
                alert('Failed to load categories. Check console for details.');
            }
        }

        function populateProductDetails(product) {
            console.log('[populateProductDetails] Populating product details:', product);
            document.getElementById('name').value = product.name || '';
            document.getElementById('img').value = product.img || '';
            document.getElementById('imagePreview').src = product.img || '';
            document.getElementById('imagePreview').style.display = product.img ? 'block' : 'none';
            document.getElementById('description').value = product.description || '';
            document.getElementById('shortdescription').value = product.shortdescription || '';
            document.getElementById('active').checked = product.active || false;

            // Populate selected categories
            populateCategoryList(product.product_category || []);
            populatePriceTable(product.product_prices || []);
        }

        function populateCategoryList(categories) {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            categories.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category.categories.name; // Access the name of the category
                li.addEventListener('click', () => removeCategory(category.categories.name));
                categoryList.appendChild(li);
            });
        }

        async function removeCategory(categoryName) {
            const productId = products[currentIndex].id;

            try {
                const { data: categories, error: fetchError } = await supabaseClient
                    .from('categories')
                    .select('id')
                    .eq('name', categoryName)
                    .single();

                if (fetchError) throw fetchError;

                const categoryId = categories.id;

                const { error } = await supabaseClient
                    .from('product_category')
                    .delete()
                    .match({ product_id: productId, category_id: categoryId });

                if (error) throw error;

                console.log('[removeCategory] Category removed successfully.');
                saveToLocalStorage();
                await loadProducts(); // Refresh products to reflect changes
                populateProductDetails(products[currentIndex]); // Keep current product data intact
            } catch (error) {
                console.error('[removeCategory] Failed to remove category:', error);
                alert('Failed to remove category. Check the console for details.');
            }
        }

        function populatePriceTable(prices) {
            const priceTableContainer = document.getElementById('priceTableContainer');
            priceTableContainer.innerHTML = createPriceTable(prices);
        }

        function createPriceTable(prices) {
            let tableHtml = '<table><tr><th>Quantity</th><th>Price</th><th>Actions</th></tr>';
            prices.forEach((price, index) => {
                tableHtml += `
                    <tr>
                        <td><input type="text" value="${price.quantity}" data-index="${index}" class="price-quantity" /></td>
                        <td><input type="number" value="${price.price}" data-index="${index}" class="price-value" /></td>
                        <td><button onclick="deletePriceRow(${index})">Delete</button></td>
                    </tr>
                `;
            });
            tableHtml += '</table>';
            return tableHtml;
        }

        async function addCategory() {
            const categoryId = document.getElementById('availableCategories').value;
            const productId = products[currentIndex].id;

            try {
                const { error } = await supabaseClient
                    .from('product_category')
                    .insert([{ product_id: productId, category_id: categoryId }]);

                if (error) throw error;

                console.log('[addCategory] Category added successfully.');
                saveToLocalStorage();
                await loadProducts(); // Refresh products to reflect changes
                populateProductDetails(products[currentIndex]); // Keep current product data intact
            } catch (error) {
                console.error('[addCategory] Failed to add category:', error);
                alert('Failed to add category. Check the console for details.');
            }
        }

        async function deletePriceRow(index) {
            console.log('[deletePriceRow] Deleting price row at index:', index);
            products[currentIndex].product_prices.splice(index, 1);
            saveToLocalStorage();
            populatePriceTable(products[currentIndex].product_prices);
        }

        function attachEventListeners() {
            document.getElementById('addPricingRowButton').addEventListener('click', () => {
                console.log('[addPricingRowButton] Adding a price row...');
                products[currentIndex].product_prices.push({ quantity: '', price: 0 });
                saveToLocalStorage();
                populatePriceTable(products[currentIndex].product_prices);
            });

            document.getElementById('addCategoryButton').addEventListener('click', addCategory);
            document.getElementById('saveRecordButton').addEventListener('click', saveRecord);
            document.getElementById('saveNewRecordButton').addEventListener('click', saveNewRecord);

            document.getElementById('previousRecordButton').addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    populateProductDetails(products[currentIndex]);
                } else {
                    alert('Already at the first record.');
                }
            });

            document.getElementById('nextRecordButton').addEventListener('click', () => {
                if (currentIndex < products.length - 1) {
                    currentIndex++;
                    populateProductDetails(products[currentIndex]);
                } else {
                    alert('Already at the last record.');
                }
            });

            document.getElementById('imageInput').addEventListener('change', previewImage);
            document.getElementById('changeImageButton').addEventListener('click', () => {
                document.getElementById('imageInput').click();
            });
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function saveToLocalStorage() {
            const product = products[currentIndex];
            product.name = document.getElementById('name').value;
            product.img = document.getElementById('img').value;
            product.description = document.getElementById('description').value;
            product.shortdescription = document.getElementById('shortdescription').value;
            product.active = document.getElementById('active').checked;
            localStorage.setItem('products', JSON.stringify(products));
        }

        function restoreFromLocalStorage() {
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
        }

        async function saveRecord() {
            saveToLocalStorage();
            const product = products[currentIndex];

            try {
                const { error } = await supabaseClient
                    .from('products')
                    .update({
                        name: product.name,
                        img: product.img,
                        description: product.description,
                        shortdescription: product.shortdescription,
                        active: product.active,
                    })
                    .eq('id', product.id);

                if (error) throw error;

                alert('Record saved successfully!');
            } catch (error) {
                console.error('[saveRecord] Failed to save record:', error);
                alert('Failed to save record. Check the console for details.');
            }
        }

        async function saveNewRecord() {
            const product = {
                name: document.getElementById('name').value,
                img: document.getElementById('img').value,
                description: document.getElementById('description').value,
                shortdescription: document.getElementById('shortdescription').value,
                active: document.getElementById('active').checked,
                product_prices: [],
                product_category: [],
            };

            try {
                const { data, error } = await supabaseClient.from('products').insert(product);

                if (error) throw error;

                products.push(data[0]);
                currentIndex = products.length - 1;
                saveToLocalStorage();
                alert('New record saved successfully!');
                populateProductDetails(data[0]);
            } catch (error) {
                console.error('[saveNewRecord] Failed to save new record:', error);
                alert('Failed to save new record. Check the console for details.');
            }
        }
    </script>
</body>

</html>