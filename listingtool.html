<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        // Ensure Supabase is defined globally
        const supabaseUrl = 'https://tjbcucdewwczndkeypey.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqYmN1Y2Rld3djem5ka2V5cGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzUwMzcsImV4cCI6MjA1MzUxMTAzN30.iBm2u7xY5qRQT6gOQw7OwAYTENJh49B9lI0YtLuKJAQ';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        console.log('[Supabase Initialized]', supabase);

        // Global variables
        let currentIndex = 0;
        let data = { products: [] };

        // Wait for the DOM to load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[DOMContentLoaded] DOM fully loaded.');

            try {
                // Ensure Supabase client is functional
                if (!supabase) {
                    throw new Error('Supabase client not initialized!');
                }

                // Fetch products and categories
                await fetchProducts();
                await fetchCategories();

                // Load the first product or initialize default data
                if (data.products.length > 0) {
                    console.log('[DOMContentLoaded] Products loaded into memory:', data.products);
                    loadProductFromMemory();
                } else {
                    console.warn('[DOMContentLoaded] No products found. Initializing default data.');
                    initializeDefaultData();
                }

                // Attach event listeners
                attachEventListeners();
            } catch (error) {
                console.error('[DOMContentLoaded] Initialization error:', error);
                alert('Initialization failed. Check the console for details.');
            }
        });

        async function fetchProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*, product_prices(quantity, price), categories(name)');
                if (error) throw error;

                data.products = products.map(product => ({
                    ...product,
                    prices: product.product_prices || [],
                    categories: product.categories.map(category => category.name) || [],
                }));

                console.log('[fetchProducts] Products fetched:', data.products);
            } catch (error) {
                console.error('[fetchProducts] Error fetching products:', error);
                alert('Failed to fetch products. Check the console for details.');
            }
        }

        async function fetchCategories() {
            try {
                const { data: categories, error } = await supabase.from('categories').select('*');
                if (error) throw error;

                const categoryDropdown = document.getElementById('availableCategories');
                categoryDropdown.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categoryDropdown.appendChild(option);
                });

                console.log('[fetchCategories] Categories fetched:', categories);
            } catch (error) {
                console.error('[fetchCategories] Error fetching categories:', error);
                alert('Failed to fetch categories. Check the console for details.');
            }
        }

        function attachEventListeners() {
            console.log('[attachEventListeners] Adding event listeners...');
            document.getElementById('addPricingRowButton').addEventListener('click', addPricingRow);
            document.getElementById('addCategoryButton').addEventListener('click', addCategory);
            document.getElementById('saveRecordButton').addEventListener('click', saveRecord);
            document.getElementById('saveNewRecordButton').addEventListener('click', saveNewRecord);
            document.getElementById('previousRecordButton').addEventListener('click', previousRecord);
            document.getElementById('nextRecordButton').addEventListener('click', nextRecord);
            console.log('[attachEventListeners] Event listeners added.');
        }

        function loadProductFromMemory() {
            const product = data.products[currentIndex];
            if (product) {
                populateProductDetails(product);
            } else {
                console.error('[loadProductFromMemory] No product found at current index.');
            }
        }

        function populateProductDetails(product) {
            document.getElementById('name').value = product.name || '';
            document.getElementById('img').value = product.img || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('shortdescription').value = product.shortdescription || '';
            document.getElementById('active').checked = product.active || false;

            const priceTableContainer = document.getElementById('priceTableContainer');
            priceTableContainer.innerHTML = '';
            const table = createPriceTable(product.prices || []);
            priceTableContainer.appendChild(table);

            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            (product.categories || []).forEach(category => {
                const li = document.createElement('li');
                li.textContent = category;
                categoryList.appendChild(li);
            });
        }

        function createPriceTable(prices = []) {
            const table = document.createElement('table');
            const headerRow = table.insertRow();
            headerRow.insertCell().textContent = 'Quantity';
            headerRow.insertCell().textContent = 'Price';
            headerRow.insertCell().textContent = 'Actions';

            prices.forEach((price, index) => {
                const row = table.insertRow();
                row.insertCell().innerHTML = `<input type="text" value="${price.quantity}" />`;
                row.insertCell().innerHTML = `<input type="number" value="${price.price}" />`;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => deletePriceRow(index));
                row.insertCell().appendChild(deleteButton);
            });

            return table;
        }

        function deletePriceRow(index) {
            const product = data.products[currentIndex];
            if (product && Array.isArray(product.prices)) {
                product.prices.splice(index, 1);
                populateProductDetails(product);
            }
        }

        function addPricingRow() {
            const product = data.products[currentIndex];
            if (!product.prices) {
                product.prices = [];
            }
            product.prices.push({ quantity: '', price: 0 });
            populateProductDetails(product);
        }

        function addCategory() {
            const category = document.getElementById('availableCategories').value;
            const product = data.products[currentIndex];

            if (!product.categories.includes(category)) {
                product.categories.push(category);
                populateProductDetails(product);
            }
        }

        async function saveRecord() {
            const product = data.products[currentIndex];
            product.name = document.getElementById('name').value;
            product.img = document.getElementById('img').value;
            product.description = document.getElementById('description').value;
            product.shortdescription = document.getElementById('shortdescription').value;
            product.active = document.getElementById('active').checked;

            try {
                const { error } = await supabase.from('products').update(product).eq('id', product.id);
                if (error) throw error;

                alert('Record saved successfully!');
            } catch (error) {
                console.error('[saveRecord] Error saving record:', error);
                alert('Failed to save record.');
            }
        }

        function saveNewRecord() {
            const newProduct = {
                id: data.products.length + 1,
                name: document.getElementById('name').value,
                img: document.getElementById('img').value,
                description: document.getElementById('description').value,
                shortdescription: document.getElementById('shortdescription').value,
                active: document.getElementById('active').checked,
                archived: false,
                prices: [],
                categories: [],
            };

            data.products.push(newProduct);
            currentIndex = data.products.length - 1;
            populateProductDetails(newProduct);
        }

        function previousRecord() {
            if (currentIndex > 0) {
                currentIndex--;
                loadProductFromMemory();
            }
        }

        function nextRecord() {
            if (currentIndex < data.products.length - 1) {
                currentIndex++;
                loadProductFromMemory();
            }
        }
    </script>
</body>

</html>
