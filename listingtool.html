<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor</title>
    <link rel="stylesheet" href="css/styles.css">

    <!-- Load Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.6.4"></script>
    <script>
        // Check if Supabase is loaded
        console.log('[Debug] Checking Supabase library:', typeof supabase);

        if (typeof supabase === 'undefined') {
            console.error('[Error] Supabase library is not loaded!');
            alert('Supabase library failed to load. Please check your network or script tag.');
        }

        // Supabase configuration
        const supabaseUrl = 'https://tjbcucdewwczndkeypey.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRqYmN1Y2Rld3djem5ka2V5cGV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc5MzUwMzcsImV4cCI6MjA1MzUxMTAzN30.iBm2u7xY5qRQT6gOQw7OwAYTENJh49B9lI0YtLuKJAQ';

        let supabase;

        try {
            supabase = supabase.createClient(supabaseUrl, supabaseKey);
            console.log('[Supabase Initialized Successfully]', supabase);
        } catch (error) {
            console.error('[Supabase Initialization Failed]', error);
            alert('Failed to initialize Supabase. Please check the console for details.');
        }

        // Debugging: Verify the Supabase object after initialization
        console.log('[Debug] Supabase object:', supabase);
    </script>
</head>

<body>
    <div id="editor">
        <!-- Your existing form elements remain the same -->
    </div>

    <script>
        // Global variables
        let currentIndex = 0;
        let data = { products: [] };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[DOMContentLoaded] DOM fully loaded.');

            if (!supabase) {
                console.error('[Error] Supabase is not initialized. Exiting script.');
                alert('Supabase client is not initialized. Cannot proceed.');
                return;
            }

            try {
                console.log('[Debug] Starting product and category fetch...');
                await fetchProducts();
                await fetchCategories();

                if (data.products.length > 0) {
                    console.log('[DOMContentLoaded] Products loaded:', data.products);
                    loadProductFromMemory();
                } else {
                    console.warn('[DOMContentLoaded] No products found.');
                    initializeDefaultData();
                }

                attachEventListeners();
            } catch (error) {
                console.error('[Error] Failed during initialization:', error);
                alert('Error occurred during initialization. Check console for details.');
            }
        });

        async function fetchProducts() {
            try {
                console.log('[fetchProducts] Fetching products...');
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*, product_prices(quantity, price), categories(name)');
                if (error) throw error;

                data.products = products.map(product => ({
                    ...product,
                    prices: product.product_prices || [],
                    categories: product.categories.map(category => category.name) || [],
                }));

                console.log('[fetchProducts] Products fetched:', data.products);
            } catch (error) {
                console.error('[fetchProducts] Error fetching products:', error);
                alert('Failed to fetch products. Check the console for details.');
            }
        }

        async function fetchCategories() {
            try {
                console.log('[fetchCategories] Fetching categories...');
                const { data: categories, error } = await supabase.from('categories').select('*');
                if (error) throw error;

                const categoryDropdown = document.getElementById('availableCategories');
                categoryDropdown.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categoryDropdown.appendChild(option);
                });

                console.log('[fetchCategories] Categories fetched:', categories);
            } catch (error) {
                console.error('[fetchCategories] Error fetching categories:', error);
                alert('Failed to fetch categories. Check the console for details.');
            }
        }

        function attachEventListeners() {
            console.log('[attachEventListeners] Adding event listeners...');
            document.getElementById('addPricingRowButton').addEventListener('click', addPricingRow);
            document.getElementById('addCategoryButton').addEventListener('click', addCategory);
            document.getElementById('saveRecordButton').addEventListener('click', saveRecord);
            document.getElementById('saveNewRecordButton').addEventListener('click', saveNewRecord);
            document.getElementById('previousRecordButton').addEventListener('click', previousRecord);
            document.getElementById('nextRecordButton').addEventListener('click', nextRecord);
            console.log('[attachEventListeners] Event listeners added.');
        }

        // Other functions like populateProductDetails, saveRecord, etc., remain unchanged.
    </script>
</body>

</html>
