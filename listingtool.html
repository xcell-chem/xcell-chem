<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Tool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
        const supabaseUrl = 'https://your-supabase-url.supabase.co';
        const supabaseKey = 'your-anon-key';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>
</head>
<body>
    <h1>Product Listing Tool</h1>

    <!-- Form for adding new products -->
    <form id="listing-form">
        <label for="product-name">Product Name:</label>
        <input type="text" id="product-name" required><br><br>

        <label for="product-description">Description:</label>
        <textarea id="product-description" required></textarea><br><br>

        <label for="product-short-description">Short Description:</label>
        <textarea id="product-short-description" required></textarea><br><br>

        <label for="category">Category:</label>
        <input type="text" id="category" required><br><br>

        <label for="product-image">Product Image:</label>
        <input type="file" id="product-image" accept="image/*" required><br><br>

        <label for="product-prices">Prices (JSON format):</label>
        <textarea id="product-prices" required placeholder='[{"quantity": "100g", "price": 8.75}]'></textarea><br><br>

        <button type="submit">Add Product</button>
    </form>

    <h2>Existing Products</h2>
    <div id="product-list"></div>

    <script>
        // Form submission for adding a product
        document.getElementById('listing-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const shortDescription = document.getElementById('product-short-description').value;
            const categoryId = document.getElementById('category').value;
            const imageFile = document.getElementById('product-image').files[0];
            const prices = JSON.parse(document.getElementById('product-prices').value);

            try {
                // Upload image to Supabase Storage
                const { data: imageData, error: imageError } = await supabase.storage
                    .from('product-images')
                    .upload(`public/${imageFile.name}`, imageFile);
                if (imageError) throw imageError;

                const imageUrl = `${supabaseUrl}/storage/v1/object/public/product-images/${imageData.path}`;

                // Insert product into the database
                const { data: product, error: productError } = await supabase
                    .from('products')
                    .insert([{ name, description, shortDescription, category_id: categoryId, img: imageUrl, active: true, archived: false }])
                    .select('*')
                    .single();
                if (productError) throw productError;

                // Insert prices into the product_prices table
                const priceInserts = prices.map((price) => ({
                    product_id: product.id,
                    quantity: price.quantity,
                    price: price.price,
                }));

                const { error: pricesError } = await supabase.from('product_prices').insert(priceInserts);
                if (pricesError) throw pricesError;

                alert('Product added successfully!');
                loadProducts();
            } catch (error) {
                console.error('Error adding product:', error);
                alert('Failed to add the product. Please try again.');
            }
        });

        // Load existing products
        async function loadProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*, product_prices(quantity, price)');
                if (error) throw error;

                const container = document.getElementById('product-list');
                container.innerHTML = '';

                products.forEach((product) => {
                    const productElement = document.createElement('div');
                    productElement.className = 'product';
                    productElement.innerHTML = `
                        <h3>${product.name}</h3>
                        <img src="${product.img}" alt="${product.name}" style="max-width: 200px;">
                        <p>${product.shortDescription}</p>
                        <p>Prices:</p>
                        <ul>
                            ${product.product_prices
                                .map((price) => `<li>${price.quantity}: Â£${price.price.toFixed(2)}</li>`)
                                .join('')}
                        </ul>
                        <button onclick="deleteProduct(${product.id})">Delete</button>
                    `;
                    container.appendChild(productElement);
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Delete a product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                // Delete product prices first
                const { error: priceError } = await supabase
                    .from('product_prices')
                    .delete()
                    .eq('product_id', productId);
                if (priceError) throw priceError;

                // Delete the product
                const { error: productError } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);
                if (productError) throw productError;

                alert('Product deleted successfully!');
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete the product.');
            }
        }

        // Load products on page load
        loadProducts();
    </script>
</body>
</html>
