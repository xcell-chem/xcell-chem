<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Editor</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="editor">
        <div class="container">
            <div class="left-column">
                <label for="name">Product Name</label>
                <input type="text" id="name" />
                <label for="img">Image URL</label>
                <input type="text" id="img" />
                <button id="changeImageButton">Change Image</button>
                <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="previewImage(event)" />
                <img id="imagePreview" src="" alt="Product Image" style="display:none;" />

                <label for="active">Active</label>
                <input type="checkbox" id="active" />
                <label for="archived">Archived</label>
                <input type="checkbox" id="archived" disabled />

                <div>
                    <button id="saveRecordButton" type="button">Save Record</button>
                    <button id="saveNewRecordButton" type="button">Save New Record</button>
                </div>
                <div>
                    <button id="previousRecordButton" type="button">Previous</button>
                    <button id="nextRecordButton" type="button">Next</button>
                </div>
            </div>

            <div class="middle-column">
                <label for="shortdescription">Short Description</label>
                <textarea id="shortdescription" rows="4" cols="30"></textarea>
                <label for="description">Description</label>
                <textarea id="description" rows="4" cols="30"></textarea>
            </div>

            <div class="right-column">
                <h3>Categories</h3>
                <ul class="category-list" id="categoryList"></ul>
                <select id="availableCategories"></select>
                <button id="addCategoryButton" type="button">Add Category</button>

                <h3>Prices</h3>
                <div id="priceTableContainer"></div>
                <button id="addPricingRowButton" type="button">Add Price</button>
            </div>
        </div>
    </div>

    <script>
        let currentIndex = 0;
        let data = { products: [] };

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[DOMContentLoaded] Page loaded.');
            const savedData = JSON.parse(localStorage.getItem('currentProductData'));

            if (savedData) {
                data = savedData;
                console.log('[DOMContentLoaded] Restored data from localStorage:', data);
                loadProductFromLocalStorage();
            } else {
                console.log('[DOMContentLoaded] No saved data in localStorage. Fetching from JSON.');
                fetchProducts().then(() => {
                    if (data.products && data.products.length > 0) {
                        console.log('[DOMContentLoaded] Fetched products loaded into memory:', data);
                        localStorage.setItem('currentProductData', JSON.stringify(data));
                        loadProductFromLocalStorage();
                    } else {
                        console.warn('[DOMContentLoaded] No products fetched. Initializing default data.');
                        initializeDefaultData();
                    }
                });
            }

            fetchCategories();
            attachEventListeners();
        });

        function attachEventListeners() {
            console.log('[attachEventListeners] Attaching event listeners...');
            document.getElementById('addPricingRowButton').addEventListener('click', addPricingRow);
            document.getElementById('addCategoryButton').addEventListener('click', addCategory);
            document.getElementById('saveRecordButton').addEventListener('click', saveRecord);
            document.getElementById('saveNewRecordButton').addEventListener('click', saveNewRecord);
            document.getElementById('previousRecordButton').addEventListener('click', previousRecord);
            document.getElementById('nextRecordButton').addEventListener('click', nextRecord);
            console.log('[attachEventListeners] Event listeners attached.');
        }

        function initializeDefaultData() {
            data = {
                products: [
                    {
                        id: 1,
                        name: 'Default Product',
                        img: '',
                        description: 'Default description for the product.',
                        shortdescription: 'Default short description.',
                        active: true,
                        archived: false,
                        prices: [
                            { quantity: '100g', price: 10.0 },
                            { quantity: '200g', price: 18.0 }
                        ],
                        categories: ['Default Category']
                    }
                ]
            };

            console.log('[initializeDefaultData] Loaded default data:', data);
            localStorage.setItem('currentProductData', JSON.stringify(data));
            populateProductDetails(data.products[0]);
        }

        function saveRecord() {
            console.log('[saveRecord] Saving current record...');
            const product = data.products[currentIndex];

            product.name = document.getElementById('name').value;
            product.img = document.getElementById('img').value;
            product.description = document.getElementById('description').value;
            product.shortdescription = document.getElementById('shortdescription').value;
            product.active = document.getElementById('active').checked;

            localStorage.setItem('currentProductData', JSON.stringify(data));
            console.log('[saveRecord] Record saved:', product);
            alert('Record saved!');
        }

        function loadProductFromLocalStorage() {
            console.log('[loadProductFromLocalStorage] Loading product from localStorage...');
            const savedData = JSON.parse(localStorage.getItem('currentProductData'));

            if (savedData && savedData.products && savedData.products.length > 0) {
                data = savedData;
                console.log('[loadProductFromLocalStorage] Data loaded from localStorage:', data);

                const product = data.products[currentIndex];
                if (product) {
                    console.log('[loadProductFromLocalStorage] Loaded product:', product);
                    populateProductDetails(product);
                } else {
                    console.error('[loadProductFromLocalStorage] No product found at current index.');
                }
            } else {
                console.warn('[loadProductFromLocalStorage] No data found in localStorage. Initializing default data...');
                initializeDefaultData();
            }
        }

        function populateProductDetails(product) {
            console.log('[populateProductDetails] Populating product details:', product);

            document.getElementById('name').value = product.name || '';
            document.getElementById('img').value = product.img || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('shortdescription').value = product.shortdescription || '';
            document.getElementById('active').checked = product.active || false;

            const priceTableContainer = document.getElementById('priceTableContainer');
            priceTableContainer.innerHTML = '';
            const table = createPriceTable(product.prices || []);
            priceTableContainer.appendChild(table);

            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            (product.categories || []).forEach(category => {
                const li = document.createElement('li');
                li.textContent = category;
                categoryList.appendChild(li);
            });
        }

        function createPriceTable(prices = []) {
            console.log('[createPriceTable] Creating table for prices:', prices);
            const table = document.createElement('table');
            const headerRow = table.insertRow();
            headerRow.insertCell().textContent = 'Quantity';
            headerRow.insertCell().textContent = 'Price';
            headerRow.insertCell().textContent = 'Actions';

            prices.forEach((price, index) => {
                const row = table.insertRow();
                const quantityCell = row.insertCell();
                const priceCell = row.insertCell();
                const actionsCell = row.insertCell();

                quantityCell.innerHTML = `<input type="text" value="${price.quantity || ''}" />`;
                priceCell.innerHTML = `<input type="number" value="${price.price || 0}" />`;

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', (event) => {
                    event.preventDefault();
                    deletePriceRow(index);
                });
                actionsCell.appendChild(deleteButton);
            });

            return table;
        }

        function deletePriceRow(index) {
            console.log('[deletePriceRow] Deleting price at index:', index);
            const product = data.products[currentIndex];
            if (product && Array.isArray(product.prices)) {
                if (index >= 0 && index < product.prices.length) {
                    product.prices.splice(index, 1);
                    console.log('[deletePriceRow] Updated prices after deletion:', product.prices);

                    product.description = document.getElementById('description').value;
                    product.shortdescription = document.getElementById('shortdescription').value;

                    localStorage.setItem('currentProductData', JSON.stringify(data));
                    loadProductFromLocalStorage();
                } else {
                    console.error('[deletePriceRow] Index out of bounds.');
                }
            } else {
                console.error('[deletePriceRow] Product or prices array is undefined.');
            }
        }

        async function fetchProducts() {
            try {
                const response = await fetch('data/products.json');
                data = await response.json();
                console.log('[fetchProducts] Fetched products:', data);

                data.products.forEach(product => {
                    if (!Array.isArray(product.prices)) {
                        product.prices = [];
                        console.warn(`[fetchProducts] Initialized empty prices array for product: ${product.name}`);
                    }
                });
            } catch (error) {
                console.error('[fetchProducts] Error loading products:', error);
                initializeDefaultData();
            }
        }

        async function fetchCategories() {
            try {
                const response = await fetch('data/categories.json');
                const categories = await response.json();
                console.log('[fetchCategories] Fetched categories:', categories);

                const categoryDropdown = document.getElementById('availableCategories');
                categoryDropdown.innerHTML = '';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categoryDropdown.appendChild(option);
                });
            } catch (error) {
                console.error('[fetchCategories] Error loading categories:', error);
            }
        }
		function addPricingRow(event) {
    event.preventDefault();
    console.log('[addPricingRow] Adding a new pricing row...');

    const product = data.products[currentIndex];
    if (product) {
        if (!Array.isArray(product.prices)) {
            product.prices = [];
            console.log('[addPricingRow] Initialized empty prices array for product:', product.name);
        }

        // Add a default pricing row
        product.prices.push({ quantity: '', price: 0 });
        console.log('[addPricingRow] Updated prices array after addition:', product.prices);

        // Save changes to local storage
        localStorage.setItem('currentProductData', JSON.stringify(data));
        console.log('[addPricingRow] Changes saved to localStorage.');

        // Refresh the UI to reflect the added row
        populateProductDetails(product);
        console.log('[addPricingRow] UI updated with new pricing row.');
    } else {
        console.error('[addPricingRow] No product found at the current index.');
    }
}


        function addCategory() {
            console.log('[addCategory] Adding a category...');
            const category = document.getElementById('availableCategories').value;
            const product = data.products[currentIndex];

            if (product) {
                if (!product.categories) {
                    product.categories = [];
                }

                if (!product.categories.includes(category)) {
                    product.categories.push(category);
                    console.log('[addCategory] Added category:', category);

                    saveFormState('addCategory');
                    populateProductDetails(product);
                } else {
                    console.log('[addCategory] Category already exists:', category);
                }
            } else {
                console.error('[addCategory] No product found at the current index.');
            }
        }

        function saveNewRecord() {
            console.log('[saveNewRecord] Saving a new record...');

            const newProduct = {
                id: data.products.length + 1,
                name: document.getElementById('name').value,
                img: document.getElementById('img').value,
                description: document.getElementById('description').value,
                shortdescription: document.getElementById('shortdescription').value,
                active: document.getElementById('active').checked,
                archived: false,
                prices: [],
                categories: [],
            };

            data.products.push(newProduct);
            localStorage.setItem('currentProductData', JSON.stringify(data));
            console.log('[saveNewRecord] New product added:', newProduct);

            currentIndex = data.products.length - 1;
            populateProductDetails(newProduct);
            alert('New record saved!');
        }

        function previousRecord() {
            console.log('[previousRecord] Navigating to the previous record...');
            if (currentIndex > 0) {
                currentIndex--;
                loadProductFromLocalStorage();
                console.log('[previousRecord] Current index:', currentIndex);
            } else {
                console.log('[previousRecord] Already at the first record.');
            }
        }

        function nextRecord() {
            console.log('[nextRecord] Navigating to the next record...');
            if (currentIndex < data.products.length - 1) {
                currentIndex++;
                loadProductFromLocalStorage();
                console.log('[nextRecord] Current index:', currentIndex);
            } else {
                console.log('[nextRecord] Already at the last record.');
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imagePreview = document.getElementById('imagePreview');
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    console.log('[previewImage] Image preview updated.');
                };
                reader.readAsDataURL(file);
            } else {
                console.warn('[previewImage] No file selected for preview.');
            }
        }
    </script>
</body>

</html>
