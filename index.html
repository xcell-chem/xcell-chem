<script type="module">
    import { checkLoginStatus, openLoginPopup } from './js/auth.js';
    import { supabase } from './js/supabaseClient.js';

    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[DEBUG] Document fully loaded. Checking login status...');
        const loginButton = document.getElementById('loginButton');

        // ✅ Ensure Supabase is defined before calling it
        if (!window.supabase) {
            console.error("[DEBUG] Supabase is still undefined. Check script loading.");
            return;
        }

        // ✅ Wait for Supabase session to be ready before checking login
        await new Promise(resolve => setTimeout(resolve, 500));

        // ✅ Refresh session only if Supabase is available
        const session = await supabase.auth.getSession();
        if (!session || !session.session) {
            console.warn("[DEBUG] No active session found. Trying to refresh...");
            await supabase.auth.refreshSession();
        }

        // ✅ Check if user is logged in
        const isLoggedIn = await checkLoginStatus();

        if (isLoggedIn) {
            console.log('[DEBUG] User is logged in.');
            loginButton.textContent = "Logout";
        } else {
            console.warn('[DEBUG] User is not logged in.');
            loginButton.textContent = "Login";
            loginButton.onclick = openLoginPopup;
        }
    });
</script>
